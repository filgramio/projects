<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Minimal Web Page</title>
</head>
  <body>
	<!--This draws the canvas on the webpage -->
    <canvas id="mycanvas"></canvas> 
  </body>
 
  <!-- Include the processing.js library -->
  <!-- See https://khanacademy.zendesk.com/hc/en-us/articles/202260404-What-parts-of-ProcessingJS-does-Khan-Academy-support- for differences -->
  <script src="https://cdn.jsdelivr.net/processing.js/1.4.8/processing.min.js"></script> 
  <script>
  var programCode = function(processingInstance) {
    with (processingInstance) {
      size(window.innerWidth-15, window.innerHeight-15); 
      frameRate(60);
        
      var levelMap = [
      [1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1],
      [1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1],
      [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1],
      [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1],
      [1,1,1,1,1,1,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1],
      [1,1,1,1,1,1,1,0,0,0,0,0,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,1,1,1,1],
      [0,0,0,1,1,0,1,0,0,0,0,2,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,1],
      [0,0,0,0,0,0,0,0,0,0,0,0,2,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1],
      [0,0,0,3,3,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,3,3,3,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,3,3,3,0,3,0,0,4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]];

      var Item = function(name, description, image, type, id) {
        this.name = name;
        this.description = description;
        this.image = loadImage(image);
        this.id = id;
      };
      var rock = new Item("Rock", "A small rock.", "images/items/rock.png", "item", 1);

      var itemMap = [
      [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,rock,0,0,0,0,0,0,0,0,0,0,0,rock,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,rock,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,rock,0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,rock,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,rock,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,rock,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]];

      var TutorialScreen = function(text, image) {
        this.text = text;
        this.image = loadImage(image);
      };

      var currentTutorialScreen = null;

      var shownTutorialScreens = [];

      var showTutorialScreen = function(tutorial) {
        if(currentTutorialScreen == null && !shownTutorialScreens.includes(tutorial)) {
          currentTutorialScreen = tutorial;
        }
      };
      var hideTutorialScreen = function(tutorial) {
        if(currentTutorialScreen == tutorial) {          
          shownTutorialScreens.push(currentTutorialScreen);
          currentTutorialScreen = null;
        }
      };

      var movement_tut = new TutorialScreen("Use the arrow keys\n to move around.", "images/tutorial/movement.png");
      var pickup_tut = new TutorialScreen("Press SPACE to \npick up items.", "images/tutorial/pickup.png");
      var inventory_tut = new TutorialScreen("Press Q to open the \ninventory.", "images/tutorial/inventory.png");
      var gathering_tut = new TutorialScreen("Collect one more rock\nand head to the gray box.", "images/tutorial/gathering.png");
      var numerating_tut = new TutorialScreen("Turn your rocks into numbers\nby selecting them.", "images/tutorial/numerating.png");

      var isSolid = function(n){
        switch(n) {
          case 0:
            return false;
          case 1:
            return true;
          case 2:
            return true;
          case 3:
            return true;
          case 4:
            return false;
          default:
            return false;
        }
      }

      var collisionTiles = function(x,y){
        var tiles = [];
        fill(255, 0, 0, 100);
        if(x > 15 && x < levelMap[0].length * 40-15 && y > 15 && y < levelMap.length * 40-15) {
          tiles.push(levelMap[floor((y-15)/40)][floor((x-15)/40)]);
          //rect(floor((x-15)/40) * 40,floor((y-15)/40) * 40, 40, 40);  
          tiles.push(levelMap[floor((y-15)/40)][floor((x+15)/40)]);
          //rect(floor((x+15)/40) * 40,floor((y-15)/40) * 40, 40, 40);  
          tiles.push(levelMap[floor((y+15)/40)][floor((x-15)/40)]);
          //rect(floor((x-15)/40) * 40,floor((y+15)/40) * 40, 40, 40);  
          tiles.push(levelMap[floor((y+15)/40)][floor((x+15)/40)]);
          //rect(floor((x+15)/40) * 40,floor((y+15)/40) * 40, 40, 40);              
        }else{
          return [1,1,1,1];
        }
        return tiles;
      };
      var hasCollision = function(x, y) {
        var tiles = collisionTiles(x, y);
        for (var i = 0; i < tiles.length; i++) {
          if (isSolid(tiles[i])) {
            return true;
          }
        }
        return false;
      };
      var hasToolCollision = function(tool_id,x,y){
        var tiles = collisionTiles(x,y);
        for (var i = 0; i < tiles.length; i++) {
          if (tiles[i] === tool_id) {
            return true;
          }
        }
        return false;
      }

      var itemCollisionTiles = function(x,y){
        var tiles = [];
        fill(255, 0, 0, 100);
        if(x > 15 && x < levelMap[0].length * 40-15 && y > 15 && y < levelMap.length * 40-15) {
          tiles.push(itemMap[floor((y-15)/40)][floor((x-15)/40)]);
          //rect(floor((x-15)/40) * 40,floor((y-15)/40) * 40, 40, 40);  
          tiles.push(itemMap[floor((y-15)/40)][floor((x+15)/40)]);
          //rect(floor((x+15)/40) * 40,floor((y-15)/40) * 40, 40, 40);  
          tiles.push(itemMap[floor((y+15)/40)][floor((x-15)/40)]);
          //rect(floor((x-15)/40) * 40,floor((y+15)/40) * 40, 40, 40);  
          tiles.push(itemMap[floor((y+15)/40)][floor((x+15)/40)]);
          //rect(floor((x+15)/40) * 40,floor((y+15)/40) * 40, 40, 40);              
        }else{
          return [0,0,0,0];
        }
        return tiles;
      };
      var hasItemCollision = function(x, y) {
        var tiles = itemCollisionTiles(x, y);
        for (var i = 0; i < tiles.length; i++) {
          if (tiles[i] != 0) {
            return true;
          }
        }
        return false;
      };
      var topCollisionItem = function(x,y){
        for(var i = 0; i < 4; i++){
          if(itemCollisionTiles(x,y)[i] != 0){
            return itemCollisionTiles(x,y)[i];
          }
        }
        return 0;
      };
      var topCollisionItemIndex = function(x,y){
        for(var i = 0; i < 4; i++){
          if(itemCollisionTiles(x,y)[i] != 0){
            return i
          }
        }
      };
      var topCollisionItemX = function(x,y){
        var index = topCollisionItemIndex(x,y);
        if(index == 0){
          return floor((x-15)/40);
        }else if(index == 1){
          return floor((x+15)/40);
        }else if(index == 2){
          return floor((x-15)/40);
        }else if(index == 3){
          return floor((x+15)/40);
        }
      };
      var topCollisionItemY = function(x,y){
        var index = topCollisionItemIndex(x,y);
        if(index == 0){
          return floor((y-15)/40);
        }else if(index == 1){
          return floor((y-15)/40);
        }else if(index == 2){
          return floor((y+15)/40);
        }else if(index == 3){
          return floor((y+15)/40);
        }
      };
      
      var x = 100;
      var y = 100;
      var movable = true;

      var numeratorImage = loadImage("images/tiles/numerator.png");

      var inventory = {
        numbers:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        items:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        armor:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        weapons:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        abilites:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      };

      var keys = [];
      keyPressed = function() {
        keys[keyCode] = true;
      };
      keyReleased = function() {
        keys[keyCode] = false;
      };

      var mouseIsPressed = false;
      var startMouseX = 0;
      var startMouseY = 0;

      var cameraX = width/2;
      var cameraY = height/2;
      var cameraZoom = 1;
      
      var inventoryOpen = false;
      var inventoryHovered = 0;
      var inventorySelected = 0;
      var inventoryPage = inventory.items;

      var numberColors = [color(100,255,100),color(255,0,0)];

      var numeratorOpen = false;      

      var sunAngle = 1;

      mousePressed = function() {
        mouseIsPressed = true;
        startMouseX = mouseX;
        startMouseY = mouseY;
      };
      mouseReleased = function() {
        mouseIsPressed = false;
      };

      var playerImage = loadImage("images/player.png");

      imageMode(CENTER);
      textAlign(CENTER);

      showTutorialScreen(movement_tut);

      draw = function() {
        background(255);
        pushMatrix();
        translate(-cameraX+width/2, -cameraY+height/2);

        //Draw map
        for (var i = levelMap.length-1; i > -1; i--) {
          for (var j = levelMap[i].length-1; j > -1; j--) {
            noStroke();
            switch (levelMap[i][j]) {
              case 0:
                fill(50,205,50);
                rect(j * 40, i * 40, 40, 40);
              break;
              case 1:
                fill(150);
                rect(j * 40, i * 40, 40, 40);
                fill(200);
                rect(j * 40, i * 40, 40, 20);
                if (i < levelMap.length-1 && levelMap[i+1][j] == 1) {
                  fill(200);
                  rect(j * 40, i * 40, 40, 40);
                }
                if(j < levelMap[0].length-1 && levelMap[i][j+1] == 0) {
                  fill(100,100,100,180);
                  translate(j * 40, i * 40);
                  quad(40,0,40,40,50,40,50,10);
                  if(j < levelMap[0].length-1 && i < levelMap.length-1 && levelMap[i+1][j+1] == 0){
                    triangle(40,40,50,40,50,50);
                  }
                  translate(-j * 40, -i * 40);                   
                }
                if(i < levelMap.length-1 && levelMap[i+1][j] == 0) {
                  fill(100,100,100,180);
                  translate(j * 40, i * 40);
                  quad(0,40,40,40,40,50,10,50);
                  if(j < levelMap[0].length-1 && i < levelMap.length-1 && levelMap[i+1][j+1] == 0){
                    triangle(40,40,40,50,50,50);
                  }
                  translate(-j * 40, -i * 40);                   
                }
              break;
              case 2:
                fill(50,205,50);
                rect(j * 40, i * 40, 40, 40);          
                pushMatrix();
                translate(j * 40, i * 40);
                fill(101,67,33);      
                ellipse(20,35,6,6);
                rect(17,20,6,15);
                fill(34,139,34);  
                ellipse(20,17,26,26);
                popMatrix();
              break;
              case 3:
                fill(50, 205, 50);
                rect(j * 40, i * 40, 40, 40);
                pushMatrix();
                translate(j * 40, i * 40);
                fill(0,191,255);
                rect(0,0,40,40,5);
                var u = false;
                var d = false;
                var l = false;
                var r = false;
                if(j < levelMap[0].length-1 && levelMap[i][j+1] == 3){
                  r = true;
                }
                if(j > 0 && levelMap[i][j-1] == 3){
                  l = true;
                }
                if(i < levelMap.length-1 && levelMap[i+1][j] == 3){
                  d = true;
                }
                if(i > 0 && levelMap[i-1][j] == 3){
                  u = true;
                }
                if(r || d){
                  fill(0,191,255);
                  rect(35,35,5,5);
                }
                if(r || u){
                  fill(0,191,255);
                  rect(35,0,5,5);
                }
                if(l || u){
                  fill(0,191,255);
                  rect(0,0,5,5);
                }
                if(l || d){
                  fill(0,191,255);
                  rect(0,35,5,5);
                }


                popMatrix();
              break;
              case 4:
                fill(50, 205, 50);
                rect(j * 40, i * 40, 40, 40);
                image(numeratorImage,j*40+20,i*40+20);
              break;
            }
          }
        }

        //Draw item map

        for (var i = itemMap.length-1; i > -1; i--) {
          for (var j = itemMap[i].length-1; j > -1; j--) {
            if(itemMap[i][j] != 0) {
              image(itemMap[i][j].image, j * 40 + 20, i * 40 + 20);
            }
          }
        }

        //Draw the player
        image(playerImage, x, y);

        //Draw tutorial screen
        if(currentTutorialScreen != null) {
          fill(0, 0, 0, 150);
          popMatrix();
          pushMatrix();
          translate(0,height*3/4);
          rect(0, 0, width, height/4);
          translate(width/2-250, 0);
          image(currentTutorialScreen.image, 100, 100);
          fill(255);
          textSize(20);
          text(currentTutorialScreen.text, 350, 100);
          popMatrix();
          pushMatrix();
          translate(-cameraX+width/2, -cameraY+height/2);
        }

        //Camera movement
        if (mouseIsPressed && mouseButton == LEFT && movable) {
          var deltaX = mouseX - startMouseX;
          var deltaY = mouseY - startMouseY;
          if(width < levelMap[0].length * 40) {
            cameraX -= deltaX;
          }
          if(height < levelMap.length * 40) {
            cameraY -= deltaY;
          }
          startMouseX = mouseX;
          startMouseY = mouseY;
        }
        if(width < levelMap[0].length * 40) {
          cameraX = constrain(cameraX,width/2,levelMap[0].length * 40 - width/2);
        }
        if(height < levelMap.length * 40) {
          cameraY = constrain(cameraY,height/2,levelMap.length * 40 - height/2);
        }
        //println("Camera Position: (" + cameraX + ", " + cameraY + ")");
        
        //movement
        if (movable) {
          if((keys[LEFT] || keys[65]) && !hasCollision(x-3, y)) {
            x -= 4
            if(currentTutorialScreen == movement_tut){
              hideTutorialScreen(movement_tut);
            }
          }
          if((keys[RIGHT] || keys[68]) && !hasCollision(x+3, y)) {
            x += 4
            if(currentTutorialScreen == movement_tut){
              hideTutorialScreen(movement_tut);
            }
          }
          if((keys[UP] || keys[87]) && !hasCollision(x, y-3)) {
            y -= 4
            if(currentTutorialScreen == movement_tut){
              hideTutorialScreen(movement_tut);
            }
          }
          if((keys[DOWN] || keys[83]) && !hasCollision(x, y+3)) {
            y += 4
            if(currentTutorialScreen == movement_tut){
              hideTutorialScreen(movement_tut);
            }
          }
        }

        //pick up items
        fill(255,0,0,100);  
        rect(topCollisionItemX*40,topCollisionItemY*40,40,40);
        if(topCollisionItem(x,y) != 0){          
          fill(255);
          rect(x-22, y+16, 44, 12, 6);  
          fill(0,0,0,255);
          textSize(10);
          text("PICK UP", x, y+26);  
          textSize(12);
          if(keys[32] && movable){
            hideTutorialScreen(pickup_tut);
            showTutorialScreen(inventory_tut);
            var item = topCollisionItem(x,y);
            itemMap[topCollisionItemY(x,y)][topCollisionItemX(x,y)] = 0;
            for(var i = 0; i < inventoryPage.length; i++){
              if(inventoryPage[i] == 0){
                inventoryPage[i] = item;
                break;
              }
            }
          }
          showTutorialScreen(pickup_tut);
        }

        //Use Tools

        //Numerator
        if(hasToolCollision(4,x,y)){
          fill(255);
          rect(x-15, y+16, 30, 12, 6);  
          fill(0,0,0,255);
          textSize(10);
          text("USE", x, y+26);  
          textSize(12);
          if(keys[32] && movable){
            hideTutorialScreen(gathering_tut);
            showTutorialScreen(numerating_tut);
            numeratorOpen = true;
            movable = false;
            keys[32] = false;
          }
        }

        //Inventory
        if(keys[81]) {
          inventoryOpen = !inventoryOpen;
          hideTutorialScreen(inventory_tut);
          movable = !movable; // Toggle movement when inventory is opened
          keys[81] = false; // Reset the key state to prevent toggling every frame
          if(!inventoryOpen){
            showTutorialScreen(gathering_tut);
          }
        }

        //Draw inventory

        if(inventoryOpen) {
          popMatrix();
          pushMatrix();
          translate(width/2-240, height/2-350);
          fill(180,100,40);  
          rect(0,60, 480, 480);  
          fill(140,50,20);  
          rect(0,0, 480, 60);
          rect(0,540, 480, 160);
          fill(0);
          inventoryHovered = constrain(constrain(floor((mouseX-(width/2-240))/80),0,5)+6*constrain(floor((mouseY-(height/2-370))/80),0,6)-6, 0, 35);
          if(mouseIsPressed && mouseButton == LEFT) {
            inventorySelected = inventoryHovered;
          }
          for(var i = 0; i < 36; i++) {
            if(inventorySelected == i) {
              stroke(255);
              fill(255);
              rect((i%6)*80+5,floor(i/6)*80+65,70,70);
              noStroke();
            }
            fill(140,50,20);  
            rect((i%6)*80+10,floor(i/6)*80+70,60,60);
            if(inventoryPage[i] != 0) {
              image(inventoryPage[i].image, (i%6)*80+40,floor(i/6)*80+100);
            }            
            if(inventoryHovered == i) {
              stroke(255);
              fill(255,255,255,100);
              rect((i%6)*80+10,floor(i/6)*80+70,60,60);
              noStroke();
            }
          }  
          if(inventoryPage[inventorySelected] != 0){
            image(inventoryPage[inventorySelected].image, 140, 620, 100, 100);
            fill(255);
            textSize(25);
            textAlign(LEFT);
            text(inventoryPage[inventorySelected].name,200,610); 
            textSize(15);
            text(inventoryPage[inventorySelected].description,200,635); 
            textAlign(CENTER);
          }
          popMatrix();
          pushMatrix();
          translate(-cameraX+width/2, -cameraY+height/2);
        }

        //Draw numerator menu

        if(numeratorOpen) {
          var inventoryMouseX = mouseX-(width/2-240);
          var inventoryMouseY = mouseY-(height/2-350);
          popMatrix();
          pushMatrix();
          translate(width/2-240, height/2-350);
          fill(180,100,40);  
          rect(0,60, 480, 480);  
          fill(140,50,20);  
          rect(0,0, 480, 60);
          rect(0,540, 480, 160);
          fill(0);
          inventoryHovered = constrain(constrain(floor((mouseX-(width/2-240))/80),0,5)+6*constrain(floor((mouseY-(height/2-370))/80),0,6)-6, 0, 35);
          if(mouseIsPressed && mouseButton == LEFT) {
            inventorySelected = inventoryHovered;
          }
          for(var i = 0; i < 36; i++) {
            if(inventorySelected == i) {
              stroke(255);
              fill(255);
              rect((i%6)*80+5,floor(i/6)*80+65,70,70);
              noStroke();
            }
            fill(140,50,20);  
            rect((i%6)*80+10,floor(i/6)*80+70,60,60);
            if(inventoryPage[i] != 0) {
              image(inventoryPage[i].image, (i%6)*80+40,floor(i/6)*80+100);
            }            
            if(inventoryHovered == i) {
              stroke(255);
              fill(255,255,255,100);
              rect((i%6)*80+10,floor(i/6)*80+70,60,60);
              noStroke();
            }
          }  
          fill(180,100,40);  
          rect(90,580,60,60);
          rect(330,580,60,60);
          rect(171,600,110,20);
          triangle(280,580,280,640,310,610);
          if(inventoryPage[inventorySelected] != 0){
            image(inventoryPage[inventorySelected].image, 120, 610);

          }
          if(keys[32]){
            numeratorOpen = false;
            movable = true;
          }
          popMatrix();
          pushMatrix();
          translate(-cameraX+width/2, -cameraY+height/2);
        }

        popMatrix();
      };


    }};

  // Get the canvas that ProcessingJS will use
  var canvas = document.getElementById("mycanvas"); 
  // Pass the function to ProcessingJS constructor
  var processingInstance = new Processing(canvas, programCode); 
  </script>
</html>