<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Building Box</title>
</head>
  <body>
	<!--This draws the canvas on the webpage -->
    <canvas id="mycanvas"></canvas> 
  </body>
 
  <!-- Include the processing.js library -->
  <!-- See https://khanacademy.zendesk.com/hc/en-us/articles/202260404-What-parts-of-ProcessingJS-does-Khan-Academy-support- for differences -->
  <script src="https://cdn.jsdelivr.net/processing.js/1.4.8/processing.min.js"></script> 
  <script>
  var programCode = function(processingInstance) {
    with (processingInstance) {
      size(window.innerWidth-15, window.innerHeight-15); 
      frameRate(30);
        
      // Paste code from Khan Academy here:

      var keys = [];

      keyPressed = function() {
        keys[keyCode] = true;
      };
      keyReleased = function() {
        keys[keyCode] = false;
      };

      var mouseIsPressed = false;
      mousePressed = function() {
        mouseIsPressed = true;
      };
      mouseReleased = function() {
        mouseIsPressed = false;
      };

      var imgs = {
        player: loadImage("images/player.png"),
        highlight: loadImage("images/highlight.png"),
        floor_tile: loadImage("images/floor_tile.png"),
        finish_tile: loadImage("images/finish_tile.png"),
        wall_tile: loadImage("images/wall_tile.png"),
        toggle_tile: loadImage("images/toggle_tile.png"),
        locked_tile: loadImage("images/locked_tile.png"),
        unlocked_tile: loadImage("images/unlocked_tile.png")
      };

      var Level = function(config){
        this.grid = config.grid;
        this.width = this.grid[0].length;
        this.height = this.grid.length;
        this.movable_grid = config.movable_grid;
        this.startX = config.x;
        this.startY = config.y;
        this.cornerX = width/2-this.width*25;
        this.cornerY = height/2-this.height*25;
      };


      var level1 = new Level({
        grid: [
          [1,1,1,3,2],
          [3,3,1,3,1],
          [3,3,1,1,1]],
        movable_grid: [
          [0,0,0,0,0],
          [0,0,0,0,0],
          [0,0,0,0,0]],
        x:0,
        y:0
      });

      var level2 = new Level({
        grid: [
          [3,3,4,3,2],
          [1,1,1,3,1],
          [3,3,1,5,1]],
        movable_grid: [
          [0,0,0,0,0],
          [0,0,0,0,0],
          [0,0,0,0,0]],
        x:0,
        y:1
      });

      var level3 = new Level({
        grid: [
          [1,1,1,1,1],
          [1,3,3,3,1],
          [1,5,2,3,4]],
        movable_grid: [
          [0,0,0,0,0],
          [0,0,0,0,0],
          [0,0,0,0,0]],
        x:0,
        y:2
      });

      var level4 = new Level({
        grid: [
          [1,1,1,5,1,6,1],
          [1,3,1,3,1,3,1],
          [1,3,4,3,4,3,2]],
        movable_grid: [
          [0,0,0,0,0,0,0],
          [0,0,0,0,0,0,0],
          [0,0,0,0,0,0,0]],
        x:0,
        y:2
      });

      var level5 = new Level({
        grid: [
          [3,3,3,3,3,3,3],
          [3,1,1,4,6,2,3],
          [3,3,3,3,3,3,3]],
        movable_grid: [
          [0,0,0,0,0,0,0],
          [0,0,0,0,0,0,0],
          [0,0,0,0,0,0,0]],
        x:1,
        y:1
      });

      var level11 = new Level({
        grid: [
          [1,1,1,3,1,1,1],
          [3,3,1,3,3,3,1],
          [3,3,1,1,1,3,2]],
        movable_grid: [
          [0,0,0,0,0,0,0],
          [0,0,1,0,1,0,0],
          [0,0,0,0,0,0,0]],
        x:0,
        y:0
      });

      var level12 = new Level({
        grid: [
          [3,3,3,3,3,3,3,3],
          [3,1,1,3,3,1,2,3],
          [3,3,3,3,3,3,3,3]],
        movable_grid: [
          [0,0,0,0,0,0,0,0],
          [0,0,1,1,1,1,0,0],
          [0,0,0,0,0,0,0,0]],
        x:1,
        y:1
      });

      var level13 = new Level({
        grid: [          
          [0,0,0,4,0,0,0],
          [0,0,0,0,0,0,0],
          [3,3,3,3,3,3,3],
          [3,1,1,1,5,2,3],
          [3,3,1,3,3,3,3],
          [3,3,3,3,3,3,3]],
        movable_grid: [
          [0,0,0,1,0,0,0],
          [0,0,0,0,0,0,0],
          [0,0,0,0,0,0,0],
          [0,0,0,0,0,0,0],
          [0,0,1,0,0,0,0],
          [0,0,0,0,0,0,0]],
        x:1,
        y:3
      });

      var level14 = new Level({
        grid: [
          [3,3,3,3,3,3,3,3],
          [3,1,1,5,1,6,2,3],
          [3,3,1,3,4,3,3,3],
          [3,3,3,3,3,3,3,3]],
        movable_grid: [
          [0,0,0,0,0,0,0,0],
          [0,0,0,0,0,0,0,0],
          [0,0,1,0,1,0,0,0],
          [0,0,0,0,0,0,0,0]],
        x:1,
        y:1
      });


      var levels = [level1,level2,level3,level4,level5,level11,level12,level13,level14];
      var currentLevelID = 0;
      var currentLevel = levels[currentLevelID];

      var walkable = function(tile){
        switch(tile){
          case 0: return false; break;
          case 1: return true; break;
          case 2: return true; break;
          case 3: return false; break;
          case 4: return true; break;
          case 5: return false; break;
          case 6: return true; break;
        }
        return false;
      }

      var player = {
        x: currentLevel.startX,
        y: currentLevel.startY
      };

      var drawTile = function(x,y,tile){
        switch(tile){
          case 1:
            image(imgs.floor_tile, x, y, 50, 50);
          break;
          case 2:
            image(imgs.finish_tile, x, y, 50, 50);
          break;
          case 3:
            image(imgs.wall_tile, x, y, 50, 50);
          break;
          case 4:
            image(imgs.toggle_tile, x, y, 50, 50);
          break;
          case 5:
            image(imgs.locked_tile, x, y, 50, 50);
          break;
          case 6:
            image(imgs.unlocked_tile, x, y, 50, 50);
          break;
        }
      };

      var drawMap = function(level,x,y){
        pushMatrix();
        translate(x-level.width*25, y-level.height*25);
        for(var y=0; y<level.height; y++){
          for(var x=0; x<level.width; x++){
            var tile = level.grid[y][x];
            drawTile(x*50, y*50, tile);
            if(level.movable_grid[y][x] === 1){
              image(imgs.highlight, x*50, y*50, 50, 50);
            }
          }
        }
        popMatrix();
      };

      var togglePress = function(){
        for(var y=0; y<currentLevel.height; y++){
          for(var x=0; x<currentLevel.width; x++){
            if(currentLevel.grid[y][x] === 5){
              currentLevel.grid[y][x] = 6;
            } else if(currentLevel.grid[y][x] === 6){
              currentLevel.grid[y][x] = 5;
            }
          }
        }
      };

      var toggleCheck = false;

      var isMouseInBox = function(x,y,w,h){
        return mouseX > x && mouseX < x+w && mouseY > y && mouseY < y+h;
      };

      var tileX = 0;
      var tileY = 0;
      var holdingTile = false;
      var holdedTile;

      draw = function() {
        background(20);        

        //setup
        tileX = floor((mouseX-(width/2-currentLevel.width*25))/50);
        tileY = floor((mouseY-(height/2-currentLevel.height*25))/50);

        //draw level
        drawMap(currentLevel,width/2,height/2);

        //draw player

        image(imgs.player, currentLevel.cornerX+player.x*50, currentLevel.cornerY+player.y*50, 50, 50);

        //move player

        if(!holdingTile){
          if(keys[UP] && currentLevel.grid[player.y-1] && walkable(currentLevel.grid[player.y-1][player.x])){
            player.y--;
            keys[UP] = false;
          }
          if(keys[DOWN] && currentLevel.grid[player.y+1] && walkable(currentLevel.grid[player.y+1][player.x])){
            player.y++;
            keys[DOWN] = false;
          }
          if(keys[LEFT] && walkable(currentLevel.grid[player.y][player.x-1])){
            player.x--;
            keys[LEFT] = false;
          }
          if(keys[RIGHT] && walkable(currentLevel.grid[player.y][player.x+1])){
            player.x++;
            keys[RIGHT] = false;
          }
        }

        //Toggle lock

        if(currentLevel.grid[player.y][player.x] == 4 && !toggleCheck){
          togglePress();
          toggleCheck = true;
        }else if(currentLevel.grid[player.y][player.x] !== 4){
          toggleCheck = false;
        }

        //check win

        if(currentLevel.grid[player.y][player.x] === 2){
          currentLevelID++;
          if(levels[currentLevelID]){
            currentLevel = levels[currentLevelID];
            player.x = currentLevel.startX;
            player.y = currentLevel.startY;
          } else {
            //no more levels
            textAlign(CENTER);
            fill(255);
            textSize(50);
            text("You win!", width/2, height/2);
          }
        }

        //pick up

        if(!holdingTile){
          if(tileX >= 0 && tileX < currentLevel.width && tileY >= 0 && tileY < currentLevel.height){
            if(currentLevel.movable_grid[tileY][tileX] == 1){
              if(mouseIsPressed){
                mouseIsPressed = false;
                if(currentLevel.grid[tileY][tileX] !== 1 && !(player.x == tileX && player.y == tileY)){
                  holdedTile = currentLevel.grid[tileY][tileX];
                  currentLevel.grid[tileY][tileX] = 1;
                  holdingTile = true;
                }
              }
            }
          }
        }

        //drop

        if(holdingTile){
          if(tileX >= 0 && tileX < currentLevel.width && tileY >= 0 && tileY < currentLevel.height){
            if(currentLevel.movable_grid[tileY][tileX] == 1){
              if(mouseIsPressed){
                mouseIsPressed = false;
                if(currentLevel.grid[tileY][tileX] == 1 && !(player.x == tileX && player.y == tileY)){
                  currentLevel.grid[tileY][tileX] = holdedTile;
                  holdedTile = null;
                  holdingTile = false;
                }
              }
            }
          }
        }

        //draw cursor

        if(holdingTile){
          drawTile(mouseX-25, mouseY-25, holdedTile);
        }


      };

    }};

  // Get the canvas that ProcessingJS will use
  var canvas = document.getElementById("mycanvas"); 
  // Pass the function to ProcessingJS constructor
  var processingInstance = new Processing(canvas, programCode); 
  </script>
</html>