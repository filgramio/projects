<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>New Game</title>
    <style>
      
    </style>
</head>
  <body>
	<!--This draws the canvas on the webpage -->
    <canvas id="mycanvas"></canvas> 
  </body>
 
  <!-- Include the processing.js library -->
  <!-- See https://khanacademy.zendesk.com/hc/en-us/articles/202260404-What-parts-of-ProcessingJS-does-Khan-Academy-support- for differences -->
  <script src="https://cdn.jsdelivr.net/processing.js/1.4.8/processing.min.js"></script> 
  <script>
  var programCode = function(processingInstance) {
    with (processingInstance) {
      size(600,850); 
      frameRate(30);
        
      // Paste code from Khan Academy here:

      var keys = [];

      keyPressed = function(){
        keys[keyCode] = true;
      }

      keyReleased = function(){
        keys[keyCode] = false;
      }

      var deg = function(degrees){
        return Math.PI/180*degrees;
      };

      var debugMode = false;

      var level1 = {
        map:[
        ["0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0"],
        ["0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0"],
        ["0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0"],
        ["0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0"],
        ["0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0"],
        ["0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0"],
        ["0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0"],
        ["0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0"],
        ["0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0"],
        ["0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0"],
        ["0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0"],
        ["0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0"],
        ["0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0"],
        ["0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0"],
        ["0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0"],
        ["0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0"],
        ["0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0"],
        ["0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0"],
        ["0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0"],
        ["0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0"],
        ["0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0"],
        ["0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0"],
        ["0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0"],
        ["0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0"],
        ["0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0"],
        ["0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0"],
        ["0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0"],
        ["0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0"],
        ["0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0"],
        ["0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0"],
        ["0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0"],
        ["0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0"],
        ["0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0"],
        ["0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0"],
        ["0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0"],
        ["0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0"],
        ["0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0"],
        ["0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0"],
        ["0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0"],
        ["0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0"]],
        theme:"forest"  
      };

      for(var i = 0; i < level1.map.length; i++){
        for(var j = 0; j < level1.map[i].length; j++){
          if(random(0,1) < 0.02){
            level1.map[i][j] = "1";
          }else if(random(0,1) < 0.01){
            level1.map[i][j] = "4";
          }
        }
      }
      for(var k = 0; k < 6; k++){
        for(var i = 0; i < level1.map.length; i++){
          for(var j = 0; j < level1.map[i].length; j++){
            var randomLimit = 0;
            if(i > 0){
              if(level1.map[i-1][j] === "1"){
                randomLimit += 0.1;
              }
            }
            if(j > 0){
              if(level1.map[i][j-1] === "1"){
                randomLimit += 0.1;
              }
            }
            if(i < level1.map.length-1){
              if(level1.map[i+1][j] === "1"){
                randomLimit += 0.1;
              }
            }
            if(level1.map[i][j+1] === "1"){
              randomLimit += 0.1;
            }
            if(random(0,1) < randomLimit){
              level1.map[i][j] = "1";
            }
          }
        }
      }

      var currentLevel = level1;

      var isSolid = function(x,y){
        switch(currentLevel.map[y][x]){
          case "0":
            return false;
          break;
          case "1":
            return true;
          break;
          case "2":
            return false;
          break;
          case "3":
            return false;
          break;
          case "4":
            return false;
          break;
        };
      };

      var drawMap = function(level){
        for (var i = 0; i < level.map.length; i++){
          for (var j = 0; j < level.map[i].length; j++){
            switch(level.theme){
              case "forest":
                switch(level.map[i][j]){
                  case "0":
                    fill(60,180,40);
                    noStroke();
                    rect(j*60,i*60,60,60);
                  break;
                  case "1":
                  fill(60,180,40);
                    noStroke();
                    rect(j*60,i*60,60,60);
                    var type = 0;
                    if(i > 0){
                      if(level.map[i-1][j] === "1"){
                        type+=1;
                      }
                    }else{
                      type+=1;
                    }
                    if(j < level.map[i].length-1){
                      if(level.map[i][j+1] === "1"){
                        type+=2;
                      }
                    }else{
                      type+=2;
                    }
                    if(i < level.map.length-1){
                      if(level.map[i+1][j] === "1"){
                        type+=4;
                      }
                    }else{
                      type+=4;
                    }
                    if(j > 0){
                      if(level.map[i][j-1] === "1"){
                        type+=8;
                      }
                    }else{
                      type+=8;
                    }
                    pushMatrix();
                    translate(j*60,i*60);
                    switch(type){
                      case 0:
                        stroke(0,0,0);
                        fill(130);
                        rect(0,0,59,59,16);
                        fill(150);
                        rect(0,0,59,26,16);
                      break;
                      case 1:
                        stroke(0,0,0);
                        fill(130);
                        rect(0,0,59,59,16);
                        fill(150);
                        rect(0,0,59,26,16);
                        rect(0,0,59,13);
                        noStroke();
                        rect(2,-2,56,18);
                      break;
                      case 2:
                        stroke(0,0,0);
                        fill(130);
                        rect(0,0,79,59,16);
                        fill(150);
                        rect(0,0,79,26,16);                        
                      break;
                      case 3:
                        stroke(0,0,0);
                        fill(130);
                        rect(0,0,79,59,16);
                        fill(150);
                        rect(0,0,79,26,16); 
                        rect(0,0,59,13);
                        noStroke();
                        rect(2,-2,59,18);
                      break;
                      case 4:
                        stroke(0,0,0);
                        fill(150);
                        rect(0,0,59,79,16);
                      break;
                      case 5:
                        stroke(0,0,0);
                        fill(150);
                        rect(0,0,59,79);
                        noStroke();
                        rect(2,-2,56,18);
                      break;
                      case 6:
                        stroke(0,0,0);
                        fill(150);
                        rect(0,0,79,79,16);
                      break;
                      case 7:
                        stroke(0,0,0);
                        fill(150);
                        rect(0,0,61,79);
                        noStroke();
                        rect(2,-2,56,18);
                      break;
                      case 8:
                        stroke(0,0,0);
                        fill(130);
                        rect(0,0,59,59,16);
                        rect(0,0,13,59);
                        noStroke();
                        rect(-2,2,18,56);
                        stroke(0,0,0);
                        fill(150);
                        rect(0,0,59,26,16);
                        rect(0,0,13,26);
                        noStroke();
                        rect(-2,2,18,23);
                      break;
                      case 9:
                        stroke(0,0,0);
                        fill(130);
                        rect(0,0,59,59,16);
                        rect(0,0,13,59);
                        noStroke();
                        rect(-2,2,18,56);
                        stroke(0,0,0);
                        fill(150);
                        rect(0,0,59,26,16);
                        rect(0,0,13,26);
                        noStroke();
                        rect(-2,2,18,23);
                        stroke(0,0,0);
                        rect(0,0,59,13);
                        noStroke();
                        rect(-2,-2,60,18);
                      break;
                      case 10:
                        noStroke();
                        fill(130);
                        rect(0,0,59,59);
                        fill(150);
                        rect(0,0,59,26);
                        stroke(0,0,0);
                        line(0,0,59,0);
                        line(0,26,59,26);
                        line(0,59,59,59);
                      break;
                      case 11:
                        noStroke();
                        fill(130);
                        rect(-2,0,64,59);
                        fill(150);
                        rect(-2,-2,64,26);
                        stroke(0,0,0);
                        line(-2,26,64,26);
                        line(-2,59,64,59);
                      break;
                      case 12:
                        stroke(0,0,0);
                        fill(150);
                        rect(0,0,59,79,16);
                        rect(0,0,18,59);
                        noStroke();
                        rect(-2,2,22,58);
                      break;
                      case 13:
                        fill(150);
                        noStroke();
                        rect(0,-2,59,61);
                        stroke(0,0,0);
                        line(59,0,59,59);
                      break;
                      case 14:
                        fill(150);
                        noStroke();
                        rect(-2,0,61,59);
                        stroke(0,0,0);
                        line(59,0,0,0);
                      break;
                      case 15:
                      fill(150);
                        noStroke();
                        rect(-2,-2,63,63);
                      break;
                    }
                    popMatrix();

                  break;
                  case "2":
                    fill(60,180,40);
                    noStroke();
                    rect(j*60,i*60,60,60);
                    pushMatrix();
                    translate(j*60,i*60);
                    fill(194,178,128);
                    noStroke();
                    rect(0,0,59,59,16);
                    if(i > 0){
                      if(level.map[i-1][j] === "2"){
                        rect(-1,-1,61,29);
                      }
                    }else{
                      rect(-1,-1,61,29);
                    }
                    if(j < level.map[i].length-1){
                      if(level.map[i][j+1] === "2"){
                        rect(32,-1,29,61);
                      }
                    }else{
                      rect(32,-1,29,61);
                    }
                    if(i < level.map.length-1){
                      if(level.map[i+1][j] === "2"){
                        rect(0,32,61,29);
                      }
                    }else{
                      rect(0,32,61,29);
                    }
                    if(j > 0){
                      if(level.map[i][j-1] === "2"){
                        rect(-1,-1,29,61);
                      }
                    }else{
                      rect(-1,-1,29,61);
                    }
                    popMatrix();
                  break;                  
                  case "3":
                    fill(60,180,40);
                    noStroke();
                    rect(j*60,i*60,60,60);
                    pushMatrix();
                    translate(j*60,i*60);
                    fill(110);
                    noStroke();
                    rect(0,0,59,59,16);
                    if(i > 0){
                      if(level.map[i-1][j] === "3"){
                        rect(-1,-1,61,29);
                      }
                    }else{
                      rect(-1,-1,61,29);
                    }
                    if(j < level.map[i].length-1){
                      if(level.map[i][j+1] === "3"){
                        rect(32,-1,29,61);
                      }
                    }else{
                      rect(32,-1,29,61);
                    }
                    if(i < level.map.length-1){
                      if(level.map[i+1][j] === "3"){
                        rect(0,32,61,29);
                      }
                    }else{
                      rect(0,32,61,29);
                    }
                    if(j > 0){
                      if(level.map[i][j-1] === "3"){
                        rect(-1,-1,29,61);
                      }
                    }else{
                      rect(-1,-1,29,61);
                    }
                    popMatrix();
                  break;
                  case "4":
                    fill(250,150,20);
                    noStroke();
                    rect(j*60,i*60,60,60);
                  break;
                }
              break;
            }
          }
        }
        fill(255,255,255);
        noStroke();
        rect(60*currentLevel.map[0].length,0,60,60*currentLevel.map.length);
        rect(0,60*currentLevel.map.length,60*currentLevel.map[0].length,0);
      };

      var inventoryKeys = [7,8,9,"+"];


      var Item = function(config){
        this.name = config.name;
        this.imageFunction = config.imageFunction;
        this.rangeType = config.rangeType;
        this.range = config.range;
        this.activate = config.activate;
      };
      var pickaxeImage = function(x,y){
        pushMatrix();
        translate(x,y);
        fill(0,0,0);
        text("Pickaxe",0,0);
        popMatrix();
      };
      var pickaxe = new Item({
        name:"Pickaxe",
        imageFunction:pickaxeImage,
        rangeType:"line",
        range:1,
        activate:function(){
          if(currentLevel.map[player.targetedBlocks[0][1]][player.targetedBlocks[0][0]] === "1"){
            currentLevel.map[player.targetedBlocks[0][1]][player.targetedBlocks[0][0]] = "0";
          }
        }
      });
      var drillImage = function(x,y){
        pushMatrix();
        translate(x,y);
        fill(0,0,0);
        text("Drill",0,0);
        popMatrix();
      };
      var drill = new Item({
        name:"Pickaxe",
        imageFunction:drillImage,
        rangeType:"line",
        range:3,
        activate:function(){
          for(var i = 0; i < player.targetedBlocks.length; i++){
            if(currentLevel.map[player.targetedBlocks[i][1]][player.targetedBlocks[i][0]] === "1"){
              currentLevel.map[player.targetedBlocks[i][1]][player.targetedBlocks[i][0]] = "0";
            }
          }
        }
      });
      var shovelImage = function(x,y){
        pushMatrix();
        translate(x,y);
        fill(0,0,0);
        text("Shovel",0,0);
        popMatrix();
      };
      var shovel = new Item({
        name:"Shovel",
        imageFunction:shovelImage,
        rangeType:"line",
        range:1,
        activate:function(){
          if(currentLevel.map[player.targetedBlocks[0][1]][player.targetedBlocks[0][0]] === "0"){
            currentLevel.map[player.targetedBlocks[0][1]][player.targetedBlocks[0][0]] = "2";
          }
          if(currentLevel.map[player.targetedBlocks[0][1]][player.targetedBlocks[0][0]] === "4"){
            currentLevel.map[player.targetedBlocks[0][1]][player.targetedBlocks[0][0]] = "0";
          }
        }
      });

      var items = [];

      var player = {
        x:60,
        y:240,
        speed:6,
        rightBlock1:[0,0],
        rightBlock2:[0,0],
        leftBlock1:[0,0],
        leftBlock2:[0,0],
        upBlock1:[0,0],
        upBlock2:[0,0],
        downBlock1:[0,0],
        downBlock2:[0,0],
        coveredBlocks:[],
        slots:[pickaxe,drill,shovel,null],
        selectedSlot:0,
        selectedItem:null,
        facing:"right",
        targetedBlocks:[],
        health:50,
        maxHealth:50
      };


      var invincibilityTick = 0;
      var damage = function(damageAmount){
        if(invincibilityTick > 0){
          return;
        }
        invincibilityTick = 30;
        player.health -= damageAmount;
        if(player.health <= 0){
          player.health = 0;
        }
      };



      strokeWeight(2);

      draw = function() {
        background(255,255,255);

        //draw the level
        pushMatrix();
        translate(max(min(0,width/2-player.x),width-currentLevel.map[0].length*30),max(min(0,(height-250)/2-player.y),(height-250)-currentLevel.map.length*30));
        scale(0.5);
        drawMap(currentLevel);

        //draw the player
        fill(255,0,0);
        ellipse(player.x*2+30,player.y*2+30,60,60);

        //draw the targeted blocks
        scale(2);
        for(var i = 0; i < player.targetedBlocks.length; i++){
          stroke(0,0,150);
          fill(50,50,255,170);
          rect(player.targetedBlocks[i][0]*30,player.targetedBlocks[i][1]*30,30,30);
        }
        popMatrix();

        //update player info

        player.rightBlock1[0] = ceil((player.x+player.speed)/30);
        player.rightBlock1[1] = floor(player.y/30);
        player.rightBlock2[0] = ceil((player.x+player.speed)/30);
        player.rightBlock2[1] = ceil(player.y/30);

        player.leftBlock1[0] = floor((player.x-player.speed)/30);
        player.leftBlock1[1] = floor(player.y/30);
        player.leftBlock2[0] = floor((player.x-player.speed)/30);
        player.leftBlock2[1] = ceil(player.y/30);

        player.upBlock1[0] = floor(player.x/30);
        player.upBlock1[1] = floor((player.y-player.speed)/30);
        player.upBlock2[0] = ceil(player.x/30);
        player.upBlock2[1] = floor((player.y-player.speed)/30);

        player.downBlock1[0] = floor(player.x/30);
        player.downBlock1[1] = ceil((player.y+player.speed)/30);
        player.downBlock2[0] = ceil(player.x/30);
        player.downBlock2[1] = ceil((player.y+player.speed)/30);

        //Debug Mode

        if(debugMode){
          fill(255,0,0,170);
          rect(player.rightBlock1[0]*30,player.rightBlock1[1]*30,30,30);
          rect(player.rightBlock2[0]*30,player.rightBlock2[1]*30,30,30);
          fill(0,255,0,170);
          rect(player.leftBlock1[0]*30,player.leftBlock1[1]*30,30,30);
          rect(player.leftBlock2[0]*30,player.leftBlock2[1]*30,30,30);
          fill(0,0,255,170);
          rect(player.upBlock1[0]*30,player.upBlock1[1]*30,30,30);
          rect(player.upBlock2[0]*30,player.upBlock2[1]*30,30,30);
          fill(255,255,0,170);
          rect(player.downBlock1[0]*30,player.downBlock1[1]*30,30,30);
          rect(player.downBlock2[0]*30,player.downBlock2[1]*30,30,30);
        }

        //move the player

        if((keys[68] || keys[RIGHT]) && player.x < currentLevel.map[0].length*30-30){
          player.facing = "right"
          if(isSolid(player.rightBlock1[0],player.rightBlock1[1]) === false && isSolid(player.rightBlock2[0],player.rightBlock2[1]) === false){
            player.x += player.speed;
          }
        }
        if((keys[65] || keys[LEFT]) && player.x > 0){
          player.facing = "left"
          if(isSolid(player.leftBlock1[0],player.leftBlock1[1]) === false && isSolid(player.leftBlock2[0],player.leftBlock2[1]) === false){
            player.x -= player.speed;
          }
        }
        if((keys[87] || keys[UP]) && player.y > 0){
          player.facing = "up"
          if(isSolid(player.upBlock1[0],player.upBlock1[1]) === false && isSolid(player.upBlock2[0],player.upBlock2[1]) === false){
            player.y -= player.speed;
          }
        }
        if((keys[83] || keys[DOWN]) && player.y < currentLevel.map.length*30-30){
          player.facing = "down"
          if(isSolid(player.downBlock1[0],player.downBlock1[1]) === false && isSolid(player.downBlock2[0],player.downBlock2[1]) === false){
            player.y += player.speed;
          }
        }
        
        //check for floor blocks

        pushMatrix();
        translate(max(min(0,width/2-player.x),width-currentLevel.map[0].length*30),max(min(0,(height-250)/2-player.y),(height-250)-currentLevel.map.length*30));
        
        player.coveredBlocks = [];

        player.coveredBlocks.push([floor(player.x/30),ceil(player.y/30)]);
        player.coveredBlocks.push([ceil(player.x/30),ceil(player.y/30)]);
        player.coveredBlocks.push([floor(player.x/30),floor(player.y/30)]);
        player.coveredBlocks.push([ceil(player.x/30),floor(player.y/30)]);
        for(var i = 0; i < player.coveredBlocks.length; i++){
          /*fill(255,0,0,170);
          rect(player.coveredBlocks[i][0]*30,player.coveredBlocks[i][1]*30,30,30);*/
          switch(currentLevel.map[player.coveredBlocks[i][1]][player.coveredBlocks[i][0]]){            
            case "4":
              damage(5);
            break;
          }
        }
        popMatrix();

        //draw the inventory

        pushMatrix();
        translate(0,-100);


        fill(150);
        rect(0,height-150,width,150);
        fill(110);

        player.selectedItem = player.slots[player.selectedSlot];

        for(var i = 0; i < 4; i++){
          noStroke();
          if(player.selectedSlot === i){
            fill(0,0,255);
            rect(20+150*i,height-115,110,110);
          }
          fill(110);
          rect(25+150*i,height-110,100,100);
          strokeWeight(3);
          stroke(0,0,0);
          pushMatrix();
          translate(25+150*i+50,height-150);
          fill(255,255,255);
          rect(-15,2,30,30,5);
          rect(-11,2,22,22,5);
          line(10,23,13,31);
          line(-10,23,-13,31);
          strokeWeight(2);
          textAlign(CENTER);
          fill(0,0,0);
          textSize(15);
          text(inventoryKeys[i],0,19);
          if(player.slots[i] !== null){
            player.slots[i].imageFunction(0,90);
          }
          popMatrix();
        }
        
        popMatrix();

        //draw the stats bar

        fill(150);
        rect(0,height-100,width,100);

        pushMatrix();
        translate(0,height-100);

        fill(255,0,0);
        noStroke();
        quad(30,50,50,30,70,50,50,70);
        ellipse(60,40,sqrt(800),sqrt(800));
        ellipse(40,40,sqrt(800),sqrt(800));
        fill(110);
        rect(100,20,220,60);
        fill(180);
        rect(110,30,200,40);
        fill(lerpColor(color(255,0,0),color(0,200,0),player.health/player.maxHealth));
        rect(110,30,map(player.health,0,player.maxHealth,0,200),40);

        popMatrix();


        ///select the inventory slot

        if(keys[103] || keys[55]){
          player.selectedSlot = 0;
        }else 
        if(keys[104] || keys[56]){
          player.selectedSlot = 1;
        }else 
        if(keys[105] || keys[57]){
          player.selectedSlot = 2;
        }else 
        if(keys[107] || keys[48]){
          player.selectedSlot = 3;
        }

        
        //define the targeted blocks
        player.targetedBlocks = [];

        if(player.selectedItem){
          if(player.selectedItem.rangeType === "line"){
            switch(player.facing){
              case "right":
                for(var i = 0; i < player.selectedItem.range; i++){
                  player.targetedBlocks.push([round(player.x/30)+i+1,round(player.y/30)]);
                }
              break;
              case "left":
                for(var i = 0; i < player.selectedItem.range; i++){
                  player.targetedBlocks.push([round(player.x/30)-i-1,round(player.y/30)]);
                }
              break;
              case "up":
                for(var i = 0; i < player.selectedItem.range; i++){
                  player.targetedBlocks.push([round(player.x/30),round(player.y/30)-i-1]);
                }
              break;
              case "down":
                for(var i = 0; i < player.selectedItem.range; i++){
                  player.targetedBlocks.push([round(player.x/30),round(player.y/30)+i+1]);
                }
              break;
            }
          }
        }

        //use the item

        if(keys[32]){
          if(player.selectedItem !== null){
            player.selectedItem.activate();
          }
          keys[32] = false;
        }

        //update the invincibility tick

        if(invincibilityTick > 0){
          invincibilityTick--;
        }

      }


    }};

  // Get the canvas that ProcessingJS will use
  var canvas = document.getElementById("mycanvas"); 
  // Pass the function to ProcessingJS constructor
  var processingInstance = new Processing(canvas, programCode); 
  </script>
</html>